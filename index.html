<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ito - 1台で遊べる協力ゲーム</title>
    <meta name="description" content="1台のスマホでみんなで遊べる協力数字ゲーム「ito」のWebアプリ版。">

    <!-- PWA -->
    <meta name="theme-color" content="#34675C">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">

    <!-- iOS support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ito">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- SortableJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            /* --- デザインシステム：ベースカラー --- */
            --bg-color: #f6f8fb;        /* アプリ全体の背景色：目に優しい薄いグレー */
            --card-bg: #ffffff;         /* カードの背景色：清潔感のある白 */
            --accent-color: #e9edf5;    /* 補助的なアクセント：区切り線や入力欄の背景 */

            /* --- メイン・アクションカラー --- */
            --primary-color: #7ccf6a;   /* プライマリー：肯定的なアクション（開始、決定） */
            --primary-hover: #63b955;   /* ホバー時の色 */

            /* --- サブカラー --- */
            --secondary-color: #4a7dff; /* セカンダリー：補助的なアクション（戻る、調整） */

            /* --- テキストカラー --- */
            --text-color: #1f2933;      /* 標準テキスト：高いコントラストの濃いグレー */
            --text-muted: #8a94a6;      /* 補助テキスト：控えめなグレー */

            /* --- 状態表示 --- */
            --success-color: #2ecc71;   /* 成功・クリア時の色 */
            --error-color: #ff4d4f;     /* 失敗・エラー時の色 */

            /* --- UI構成要素 --- */
            --radius: 18px;             /* 角丸の基準値：モダンで親しみやすい印象 */
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.08); /* 浮遊感を出すシャドウ */

            /* --- タイポグラフィ --- */
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* iOS/Android/PCに最適化 */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            overscroll-behavior-y: auto; /* Allow pull-to-refresh unless specifically problematic */
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            height: 100dvh; /* Use dynamic viewport height */
            user-select: none;
            -webkit-user-select: none;
            margin: 0;
            padding: 0;
            position: relative;
        }

        #app {
            width: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            /* Precise safe area support */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            box-sizing: border-box;
            overflow: hidden;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .screen.active {
            display: flex;
            /* 垂直中央配置の徹底 */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Titles & Text */
        h1.title-large {
            font-size: 5rem;
            font-weight: 900;
            letter-spacing: -2px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-bottom: 40px;
        }

        h2.screen-title {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 24px;
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        /* Distribution screen special layout for consistency */
        .dist-screen.active {
            justify-content: flex-start !important;
            padding-top: 40px;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .btn-group.bottom-push {
            margin-top: auto;
            margin-bottom: 20px;
        }

        button {
            border: none;
            border-radius: var(--radius);
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            width: auto; /* Not full width */
            min-width: 200px; /* Minimum reasonable width */
            height: 60px; /* Explicit height for consistency */
            max-width: 100%;
            touch-action: manipulation; /* Eliminate click delay */
        }

        button:active {
            transform: scale(0.96);
        }

        button.primary { background: var(--primary-color); color: white; }
        button.secondary { background: var(--secondary-color); color: white; }
        button.accent { background: var(--accent-color); color: black; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Inputs */
        input[type="text"], textarea {
            background: #e9edf5; /* Light gray to match the theme */
            border: 2px solid #d1d9e6;
            border-radius: var(--radius);
            padding: 16px;
            color: var(--text-color);
            font-size: 16px; /* iOS: Prevent auto-zoom on focus (must be >= 16px) */
            width: 100%;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none; /* Modern look on older iOS */
            appearance: none;
        }

        input[type="text"]:focus, textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        textarea { height: 120px; resize: none; font-size: 1.4rem; text-align: center; font-weight: bold; }

        .number-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .number-control button {
            width: 60px;
            height: 60px;
            border-radius: var(--radius);
            font-size: 1.5rem;
            padding: 0;
        }

        .number-value {
            font-size: 3rem;
            font-weight: 800;
            min-width: 60px;
            text-align: center;
        }

        /* Player List */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }

        .player-item {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: var(--radius);
        }

        .player-item input {
            background: transparent;
            border: none;
            flex: 1;
            padding: 10px 0;
        }

        .btn-clear {
            background: transparent;
            color: var(--text-muted);
            font-size: 1.5rem;
            width: 40px;
            padding: 0;
        }

        /* Card Visual */
        .card-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .big-number, .reveal-number {
            font-size: 8rem;
            font-weight: 950;
            color: #ffffff;
            /* 太い縁取り (ユーザー提供画像に近いスタイル) */
            text-shadow:
                -4px -4px 0 #2b215a,
                 4px -4px 0 #2b215a,
                -4px  4px 0 #2b215a,
                 4px  4px 0 #2b215a,
                 0 0 20px rgba(0,0,0,0.5);
            margin: 20px 0;
            line-height: 1;
        }

        .reveal-number {
            font-size: 10rem;
        }

        /* Timer */
        .timer-val {
            font-size: 6rem;
            font-weight: 900;
            color: var(--accent-color);
            text-align: center;
            margin: 40px 0;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            gap: 12px;
        }

        /* Drag Sort */
        .sortable-list {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        /* SortableJS Styles & iPhone Effects */
        .sortable-ghost {
            opacity: 0.2;
            background: rgba(0, 212, 255, 0.1) !important;
            border: 2px dashed #86AC41 !important;
        }

        .sortable-drag {
            opacity: 0.98 !important;
            background: #ffffff !important;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.7) !important;
            border: 4px solid #86AC41 !important;
            transform: scale(1.1) rotate(-2deg) !important;
            z-index: 10000 !important;
        }

        /* ぷるぷる揺れるアニメーション (iPhone風) */
        .shaking:not(.sortable-drag):not(.sortable-ghost) {
            animation: shaking 0.3s infinite;
        }

        @keyframes shaking {
            0% { transform: rotate(0.5deg); }
            25% { transform: rotate(-0.5deg); }
            50% { transform: rotate(0.4deg); }
            75% { transform: rotate(-0.4deg); }
            100% { transform: rotate(0.5deg); }
        }

        /* Unified Game Card Design */
        .game-card {
            background: #ffffff;
            color: #333333;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }

        .sort-card {
            padding: 24px;
            margin-bottom: 12px;
            min-height: 80px;
            cursor: grab;
            width: 100%;
        }

        /* Repeated styles for .sort-card since 'composes' isn't standard CSS */
        .sort-card, .card-front, .card-back {
            background: #ffffff;
            color: #333333;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .sort-label {
            width: 100%;
            padding: 8px;
            text-align: center;
            font-weight: 900;
            color: var(--text-muted);
            font-size: 0.9rem;
            opacity: 0.6;
            margin: 10px 0;
            user-select: none;
        }

        .sort-card span {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: inherit;
        }

        .floating-card span {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sort-card.dragging {
            display: none; /* Hide the actual element while dragging placeholder is handled in JS */
        }

        /* 3D Card Flip Animation */
        .reveal-container {
            width: 100%;
            display: flex;
            flex-direction: column-reverse; /* Smallest at bottom, largest at top */
            align-items: center;
            gap: 24px;
            padding: 20px 0;
            perspective: 1000px; /* Enable 3D */
        }

        .reveal-card {
            width: 100%;
            max-width: 400px;
            height: 100px;
            background: transparent;
            cursor: pointer;
            perspective: 1000px;
            display: block; /* Always visible in the list flow */
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 20px;
        }

        .reveal-card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 20px;
            box-sizing: border-box;
            /* 外枠（白） */
            background: #ffffff;
            border: 4px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px; /* 内側の色部分との隙間 */
        }

        .card-inner-color {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .card-front {
            z-index: 2;
        }

        .card-back {
            transform: rotateY(180deg);
            z-index: 1;
        }

        .r-name { font-size: 1.2rem; font-weight: bold; opacity: 0.8; }
        .r-num-big { font-size: 7rem; font-weight: 900; line-height: 1; margin-top: 10px; }

        .reveal-card.current .card-inner {
            outline: 4px solid var(--accent-color);
            outline-offset: 8px;
            transform: scale(1.05);
        }

        /* Player color dots/borders */
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .reveal-card .r-name { color: var(--text-muted); font-size: 1.2rem; }
        .reveal-card .r-num {
            font-size: 4rem;
            font-weight: 900;
            color: var(--accent-color);
            transition: all 0.3s ease;
        }

        .reveal-label {
            font-weight: 900;
            color: var(--primary-color);
            padding: 10px;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .game-status {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            font-weight: 900;
            text-align: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .game-status::after {
            content: 'タップで閉じる';
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 20px;
            font-weight: normal;
        }

        .status-clear { color: var(--success-color); }
        .status-error { color: var(--error-color); }

        /* Helpers */
        .centered { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 画面1：タイトル画面 -->
        <section id="screen-title" class="screen centered active">
            <h1 class="title-large">ito</h1>
            <div class="btn-group">
                <button class="primary" onclick="app.navTo('players')">始める</button>
                <button class="secondary" onclick="app.navTo('howto')">あそびかた</button>
            </div>
        </section>

        <!-- 遊び方画面（仕様外だが遷移先として簡易実装） -->
        <section id="screen-howto" class="screen">
            <h2 class="screen-title">あそびかた</h2>
            <div style="flex:1; overflow-y:auto; padding:10px;">
                <p>①. 1〜100の数字が各プレイヤーに1枚配られます。</p><br>
                <p>②. お題に沿って、自分の数字を言葉で表現します。</p><br>
                <p>③. 全員で話し合い、数字が小さいと思う順に並べます。</p><br>
                <p>④. 順番に数字を公開し、すべて小さい順ならクリア！</p>
            </div>
            <button class="secondary" onclick="app.navTo('title')">戻る</button>
        </section>

        <!-- 画面2：プレイヤー設定 -->
        <section id="screen-players" class="screen">
            <h2 class="screen-title">プレイヤー設定</h2>
            <div class="number-control">
                <button class="secondary" onclick="app.updatePlayerCount(-1)">←</button>
                <div id="player-count-val" class="number-value">3</div>
                <button class="secondary" onclick="app.updatePlayerCount(1)">→</button>
            </div>
            <div id="player-list" class="player-list">
                <!-- JSで動的生成 -->
            </div>
            <div class="btn-group">
                <button class="primary" onclick="app.navTo('game-setup')">ゲーム設定へ</button>
            </div>
        </section>

        <!-- 画面3：ゲーム設定 -->
        <section id="screen-game-setup" class="screen">
            <h2 class="screen-title">ゲーム設定</h2>
            <div class="input-group">
                <label class="mb-10" style="display:block; text-align:center;">~お題~</label>
                <textarea id="topic-input" placeholder="例：無人島に持っていきたいもの"></textarea>
            </div>
            <div class="mt-20">
                <label style="display:block; text-align:center;">トーク時間（分）</label>
                <div class="number-control">
                    <button class="secondary" onclick="app.updateTimerSetting(-1)">←</button>
                    <div id="timer-setting-val" class="number-value">3</div>
                    <button class="secondary" onclick="app.updateTimerSetting(1)">→</button>
                </div>
            </div>
            <div class="btn-group">
                <button class="primary" onclick="app.startGame()">設定OK！始める</button>
            </div>
        </section>

        <!-- 画面4：数字確認案内 -->
        <section id="screen-dist-info" class="screen centered dist-screen">
            <h2 id="dist-player-name" class="screen-title">プレイヤーXさん</h2>
            <div style="height: 350px; display: flex; align-items: center; justify-content: center; text-align: center;">
                <p style="font-size: 1.5rem; font-weight: bold; line-height: 1.4;">数字を表示します。<br><span style="font-size: 1rem; font-weight: normal; color: var(--text-muted);">他のプレイヤーに見られないようにしてください。</span></p>
            </div>
            <div class="btn-group bottom-push">
                <button class="primary" onclick="app.navTo('dist-reveal')">表示</button>
            </div>
        </section>

        <!-- 画面5：数字表示 -->
        <section id="screen-dist-reveal" class="screen centered dist-screen">
            <h2 id="reveal-player-name" class="screen-title">プレイヤーXさん</h2>
            <div id="dist-number-view" class="card-view" style="width: 100%; height: 350px; display: flex; align-items: center; justify-content: center;">
                <!-- JSで直接数字を表示 -->
            </div>
            <div class="btn-group bottom-push">
                <button class="primary" onclick="app.nextDistReveal()">覚えた！</button>
            </div>
        </section>

        <!-- 画面7：ゲーム開始待機 -->
        <section id="screen-wait-start" class="screen centered dist-screen">
            <h2 class="screen-title">全員確認完了</h2>
            <div style="height: 350px; display: flex; align-items: center; justify-content: center; text-align: center;">
                <p style="font-size: 1.5rem; font-weight: bold;">準備ができたら開始してください</p>
            </div>
            <div class="btn-group bottom-push">
                <button class="primary" onclick="app.startThinking()">ゲーム開始</button>
            </div>
        </section>

        <!-- 画面8：トーク & 並び替え (統合画面) -->
        <section id="screen-game-play" class="screen">
            <div class="topic-header" style="width:100%; background:rgba(0,0,0,0.05); padding:10px 15px; border-radius:12px; margin-bottom:10px;">
                <p style="color:var(--text-muted); font-size:0.8rem; text-align:center; margin-bottom:2px;">お題</p>
                <p id="timer-topic" style="color:#000; font-size:1.4rem; font-weight:900; text-align:center;"></p>
            </div>

            <div id="timer-display" class="timer-val" style="margin-bottom: 5px; font-size: 5rem; color: #000;">03:00</div>

            <div class="timer-controls" style="justify-content:center; gap:20px; margin-bottom:20px;">
                <button class="secondary" style="width:80px; padding:10px;" onclick="app.adjustTimer(-60)">-1分</button>
                <button class="secondary" style="width:80px; padding:10px;" onclick="app.adjustTimer(60)">+1分</button>
            </div>

            <p class="centered mb-10" style="font-size:1.5rem; font-weight:bold; color:#000;">小さい順に並び替え</p>
            <div id="sortable-list" class="sortable-list" style="margin-bottom: auto;">
                <!-- JSで並び替えUI -->
            </div>

            <div class="btn-group">
                <button class="primary" onclick="app.finishGamePlay()">決定</button>
            </div>
        </section>

        <!-- 画面10：結果発表 -->
        <section id="screen-result" class="screen">
            <h2 class="screen-title">結果発表</h2>
            <div id="game-status" class="game-status"></div>
            <div id="reveal-container" class="reveal-container">
                <!-- タップで次をめくる -->
            </div>
            <div id="result-btns" class="btn-group" style="margin-top:auto; display:none;">
                <button class="primary" onclick="app.startGame()">次のゲームへ</button>
                <button class="secondary" onclick="app.navTo('players')">設定へ</button>
            </div>
        </section>
    </div>

    <script>
        /**
         * アプリ全体のロジック管理オブジェクト
         */
        const app = {
            // アプリケーションの状態（データ）
            state: {
                currentScreen: 'title', // 現在表示中の画面ID
                playerCount: 3,         // 参加人数
                players: [],            // プレイヤー情報（名前、数字、色）の配列
                playerColors: [         // プレイヤーにランダムに割り振るカラーパレット
                    '#ff5252', '#4caf50', '#2196f3', '#ffeb3b', '#ff9800', '#9c27b0', '#00bcd4', '#e91e63'
                ],
                timerSetting: 3,        // 設定されたトーク時間（分）
                topic: '',              // 現在のお題
                distIndex: 0,           // 配布フェーズの現在のプレイヤー番号
                revealIndex: 0,         // 結果発表フェーズの現在のカード番号
                isGameOver: false,      // ゲーム終了フラグ
                hasError: false,        // 数字の順序ミスが発生したかの記録
                timerId: null,          // タイマーのインターバルID
                timeLeft: 0,            // 残り時間（秒）
                sortingOrder: []        // プレイヤーが並び替えた後のインデックス順序
            },

            /**
             * アプリの初回起動処理
             */
            init() {
                this.loadState();        // 保存されたデータの読み込み
                this.navTo('title');     // 初期画面（タイトル）を表示
                this.renderPlayerInputs();
                this.registerSW();       // PWA用サービスワーカーの登録

                // 結果発表オーバーレイをクリックで閉じられるように
                document.getElementById('game-status').onclick = () => {
                    document.getElementById('game-status').style.display = 'none';
                };
            },

            /**
             * 画面遷移を処理する
             * @param {string} screenId 遷移先の画面ID
             */
            navTo(screenId) {
                // 全ての画面を非表示にして、対象の画面だけ表示
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const target = document.getElementById('screen-' + screenId);
                if (target) {
                    target.classList.add('active');
                    this.state.currentScreen = screenId;
                }
                window.scrollTo(0, 0);

                // 画面遷移時に一度だけ必要な初期化処理
                if (screenId === 'dist-info') this.updateDistInfo();
                if (screenId === 'dist-reveal') this.updateDistView();
                if (screenId === 'result') this.initResult();
            },

            /**
             * プレイヤー人数の変更
             * @param {number} v 増加分(+1) または 減少分(-1)
             */
            updatePlayerCount(v) {
                const newCount = this.state.playerCount + v;
                if (newCount >= 2 && newCount <= 10) {
                    this.state.playerCount = newCount;
                    document.getElementById('player-count-val').innerText = newCount;
                    this.renderPlayerInputs(); // 入力欄を再生成
                }
            },

            /**
             * プレイヤー名入力欄の動的生成
             */
            renderPlayerInputs() {
                const list = document.getElementById('player-list');
                // 現在の入力を一時保存（人数を変えても名前が消えないように）
                const currentInputs = Array.from(list.querySelectorAll('input')).map(i => i.value);
                list.innerHTML = '';

                for (let i = 0; i < this.state.playerCount; i++) {
                    const color = this.state.playerColors[i % this.state.playerColors.length];
                    const row = document.createElement('div');
                    row.className = 'player-item';
                    const name = currentInputs[i] || this.state.players[i]?.name || '';
                    row.innerHTML = `
                        <div class="color-dot" style="background: ${color}"></div>
                        <input type="text" placeholder="プレイヤー${i+1}" value="${name}">
                        <button class="btn-clear" onclick="this.previousElementSibling.value=''">×</button>
                    `;
                    list.appendChild(row);
                }
            },

            // --- ゲーム設定 & 開始 ---
            updateTimerSetting(v) {
                const newVal = this.state.timerSetting + v;
                if (newVal >= 1 && newVal <= 30) {
                    this.state.timerSetting = newVal;
                    document.getElementById('timer-setting-val').innerText = newVal;
                }
            },

            /**
             * ゲーム開始：数字の配布とお題の設定を行う
             */
            startGame() {
                // プレイヤー情報の確定
                const inputs = document.querySelectorAll('#player-list input');
                this.state.players = Array.from(inputs).map((input, i) => ({
                    name: input.value || `プレイヤー${i+1}`,
                    number: 0,
                    color: this.state.playerColors[i % this.state.playerColors.length]
                }));

                // お題の保存
                this.state.topic = document.getElementById('topic-input').value;
                this.saveState();

                // 1-100の数字をシャッフルして配布（重複なし）
                const nums = Array.from({length: 100}, (_, i) => i + 1);
                for (let i = nums.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [nums[i], nums[j]] = [nums[j], nums[i]];
                }
                this.state.players.forEach((p, i) => p.number = nums[i]);

                this.state.distIndex = 0;
                this.navTo('dist-info'); // 配布案内画面へ
            },

            // --- 配布フロー ---
            updateDistInfo() {
                const p = this.state.players[this.state.distIndex];
                document.getElementById('dist-player-name').innerText = p.name + ' さん';
            },

            updateDistView() {
                const p = this.state.players[this.state.distIndex];
                if (!p) return;

                const revealName = document.getElementById('reveal-player-name');
                if (revealName) revealName.innerText = p.name + ' さん';

                const view = document.getElementById('dist-number-view');
                if (view) {
                    view.innerHTML = `
                        <div class="card-front" style="position: relative; width: 260px; height: 260px; border: 6px solid ${p.color};">
                            <div class="card-inner-color" style="background: ${p.color}">
                                <div style="color: rgba(255,255,255,0.8); font-size: 1rem; margin-bottom: 5px; font-weight: 900;">YOUR NUMBER</div>
                                <div class="big-number" style="margin: 0; font-size: 8rem;">${p.number}</div>
                            </div>
                        </div>
                    `;
                }
            },
            nextDistReveal() {
                if (this.state.distIndex < this.state.playerCount - 1) {
                    this.state.distIndex++;
                    this.navTo('dist-info');
                } else {
                    this.navTo('wait-start');
                }
            },

            // --- トーク & 並び替え (統合ロジック) ---
            startThinking() {
                this.navTo('game-play');
                this.state.timeLeft = this.state.timerSetting * 60;
                document.getElementById('timer-topic').innerText = `お題：${this.state.topic}`;
                this.updateTimerUI();
                this.initSorting();

                clearInterval(this.state.timerId);
                this.state.timerId = setInterval(() => {
                    if (this.state.timeLeft > 0) {
                        this.state.timeLeft--;
                        this.updateTimerUI();
                    } else {
                        clearInterval(this.state.timerId);
                    }
                }, 1000);
            },

            adjustTimer(v) {
                this.state.timeLeft = Math.max(0, this.state.timeLeft + v);
                this.updateTimerUI();
            },

            updateTimerUI() {
                const m = Math.floor(this.state.timeLeft / 60);
                const s = this.state.timeLeft % 60;
                document.getElementById('timer-display').innerText =
                    `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            },

            finishGamePlay() {
                clearInterval(this.state.timerId);
                this.navTo('result');
            },

            // --- 並び替え (SortableJS) ---
            initSorting() {
                const list = document.getElementById('sortable-list');
                this.state.sortingOrder = this.state.players.map((_, i) => i);
                this.renderSortingCards();

                // SortableJS Configuration
                if (this.sortableInstance) this.sortableInstance.destroy();
                this.sortableInstance = new Sortable(list, {
                    animation: 300,
                    delay: 250, // Long press duration (ms)
                    delayOnTouchOnly: true,
                    draggable: '.sort-card', // Only cards are draggable, not labels
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onStart: () => {
                        list.classList.add('is-dragging');
                        list.querySelectorAll('.sort-card').forEach(el => el.classList.add('shaking'));
                        if (navigator.vibrate) navigator.vibrate(50);
                    },
                    onEnd: () => {
                        list.classList.remove('is-dragging');
                        list.querySelectorAll('.sort-card').forEach(el => el.classList.remove('shaking'));

                        // Sync order to state
                        const pIndexes = Array.from(list.querySelectorAll('.p-idx')).map(el => parseInt(el.value));
                        this.state.sortingOrder = pIndexes;
                        this.saveState();
                    }
                });
            },

            renderSortingCards() {
                const list = document.getElementById('sortable-list');
                list.innerHTML = '';

                // Label: Big (Top)
                const bigLabel = document.createElement('div');
                bigLabel.className = 'sort-label';
                bigLabel.innerText = '▲ 大きい';
                list.appendChild(bigLabel);

                this.state.sortingOrder.forEach((pIdx, i) => {
                    const p = this.state.players[pIdx];
                    const card = document.createElement('div');
                    card.className = 'sort-card';
                    card.style.border = `6px solid ${p.color}`;
                    card.innerHTML = `
                        <input type="hidden" class="p-idx" value="${pIdx}">
                        <span style="font-weight: 950; font-size: 1.5rem; color: #000;">${p.name}</span>
                    `;
                    list.appendChild(card);
                });

                // Label: Small (Bottom)
                const smallLabel = document.createElement('div');
                smallLabel.className = 'sort-label';
                smallLabel.innerText = '▼ 小さい';
                list.appendChild(smallLabel);
            },

            // (Sorting is handled by SortableJS now, manual drag logic removed)
            // --- 結果発表 ---
            initResult() {
                const container = document.getElementById('reveal-container');
                const status = document.getElementById('game-status');
                status.style.display = 'none';
                status.className = 'game-status';
                status.innerText = '';
                document.getElementById('result-btns').style.display = 'none';
                container.innerHTML = '';

                this.state.revealIndex = 0;
                this.state.isGameOver = false;
                this.state.hasError = false;

                // Label: Small (Bottom - Appended first)
                const smallLabel = document.createElement('div');
                smallLabel.className = 'reveal-label';
                smallLabel.innerText = '▼ 小さい';
                container.appendChild(smallLabel);

                this.state.sortingOrder.forEach((pIdx, i) => {
                    const p = this.state.players[pIdx];
                    const card = document.createElement('div');
                    card.className = 'reveal-card';
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-front" style="border: 6px solid ${p.color}; padding: 24px;">
                                <div class="r-name" style="font-weight: 950; font-size: 1.5rem; color: #000; line-height: 1;">${p.name}</div>
                                <div style="font-size: 0.6rem; margin-top: 4px; color: #999; font-weight: 800;">タップしてめくる</div>
                            </div>
                            <div class="card-back">
                                <div class="card-inner-color" style="background: ${p.color}">
                                    <div class="big-number" style="font-size: 4rem;">${p.number}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    card.onclick = () => this.revealNext(i);
                    container.appendChild(card);
                });

                // Label: Big (Top - Appended last)
                const bigLabel = document.createElement('div');
                bigLabel.className = 'reveal-label';
                bigLabel.innerText = '▲ 大きい';
                container.appendChild(bigLabel);

                setTimeout(() => {
                    const cards = document.querySelectorAll('.reveal-card');
                    if (cards[0]) cards[0].classList.add('current');
                }, 100);
            },

            revealNext(i) {
                if (i !== this.state.revealIndex) return;

                const cards = document.querySelectorAll('.reveal-card');
                const card = cards[i];
                if (card.classList.contains('flipped')) return;

                card.classList.add('flipped');
                card.classList.remove('current');

                const pIdx = this.state.sortingOrder[i];
                const num = this.state.players[pIdx].number;

                // Vibrate for feedback
                if (navigator.vibrate) navigator.vibrate([10, 30, 20]);

                let prevNum = (i > 0) ? this.state.players[this.state.sortingOrder[i-1]].number : -1;

                if (num < prevNum) {
                    this.state.hasError = true;
                    // ミスしてもすぐには終了させず、hasErrorを記録するのみにする
                }

                this.state.revealIndex++;
                if (this.state.revealIndex === this.state.playerCount) {
                    this.state.isGameOver = true;
                    // 全てめくり終わったタイミングで、ミスがあったかどうかで結果を変える
                    setTimeout(() => {
                        this.showGameOver(!this.state.hasError);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        const nextCard = cards[this.state.revealIndex];
                        nextCard.classList.add('current');
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }
            },

            /**
             * ゲーム終了の判定とアニメーション
             * @param {boolean} isClear 数字が全て小さい順だったか
             */
            showGameOver(isClear) {
                const status = document.getElementById('game-status');
                status.innerText = isClear ? 'MISSION CLEAR!' : 'Game Over';
                status.classList.add(isClear ? 'status-clear' : 'status-error');
                status.style.display = 'flex'; // オーバーレイを表示

                // 次のゲームや設定へ進むためのボタンを表示
                document.getElementById('result-btns').style.display = 'flex';
            },

            // --- 状態保存 ---
            saveState() {
                localStorage.setItem('ito_players', JSON.stringify(this.state.players));
                localStorage.setItem('ito_topic', this.state.topic);
            },
            loadState() {
                const saved = localStorage.getItem('ito_players');
                if (saved) {
                    this.state.players = JSON.parse(saved);
                    this.state.playerCount = this.state.players.length;
                    document.getElementById('player-count-val').innerText = this.state.playerCount;
                }
                const topic = localStorage.getItem('ito_topic');
                if (topic) document.getElementById('topic-input').value = topic;
            },

            registerSW() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(() => {});
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
